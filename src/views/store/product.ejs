<section class="section">
  <div class="container product-detail">
    <div class="gallery card">
      <% const imageMedia = product.media.filter((m) => m.type === 'image'); %>
      <div class="gallery-main">
        <img id="mainProductImage" src="<%= (defaultImage && defaultImage.path) || '/images/product-placeholder-1.svg' %>" alt="<%= (defaultImage && defaultImage.alt) || product.name %>" loading="eager" />
      </div>
      <% if (imageMedia.length > 1) { %>
        <div class="thumb-row" role="list" aria-label="Product image gallery">
          <% imageMedia.forEach((m, idx) => { %>
            <button type="button" class="thumb <%= idx === 0 ? 'is-active' : '' %>" data-gallery-thumb data-src="<%= m.path %>" data-alt="<%= m.alt || product.name %>">
              <img src="<%= m.path %>" alt="<%= m.alt || product.name %>" loading="lazy" />
            </button>
          <% }) %>
        </div>
      <% } %>
      <% const video = product.media.find((m) => m.type === 'video'); %>
      <% if (video) { %>
        <div class="media-block">
          <h3>Product Video</h3>
          <video controls preload="metadata" class="product-video">
            <source src="<%= video.path %>" />
            Your browser does not support video playback.
          </video>
        </div>
      <% } %>
      <% const model = product.media.find((m) => m.type === 'model'); %>
      <% if (model) { %>
        <div class="media-block">
          <h3>3D Preview (Optional)</h3>
          <model-viewer src="<%= model.path %>" camera-controls touch-action="pan-y" auto-rotate></model-viewer>
          <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
        </div>
      <% } %>
    </div>

    <div class="product-panel card">
      <p class="eyebrow"><%= product.category %></p>
      <h1><%= product.name %></h1>
      <p class="muted">SKU: <%= product.sku %></p>
      <div class="price-row">
        <span class="price"><%= formatCurrency(product.price) %></span>
        <span class="badge <%= product.availability.toLowerCase().replace(/\s+/g, '-') %>"><%= product.availability %></span>
      </div>

      <p><%= product.description %></p>

      <ul class="spec-list">
        <li><strong>Lace Type:</strong> <%= product.lace_type %></li>
        <li><strong>Density:</strong> <%= product.density %></li>
        <li><strong>Cap Size:</strong> <%= product.cap_size %></li>
        <li><strong>Stock Quantity:</strong> <%= product.stock_qty %></li>
      </ul>

      <form method="post" action="/cart/add" class="product-form">
        <input type="hidden" name="productId" value="<%= product.id %>" />

        <label>Color
          <select name="color" required>
            <% product.colors.forEach((color) => { %>
              <option value="<%= color %>"><%= color %></option>
            <% }) %>
          </select>
        </label>

        <label>Length (inches)
          <select name="length" required>
            <% product.lengths.forEach((length) => { %>
              <option value="<%= length %>"><%= length %>"</option>
            <% }) %>
          </select>
        </label>

        <label>Quantity
          <input type="number" name="quantity" min="1" max="<%= Math.max(product.stock_qty, 1) %>" value="1" />
        </label>

        <div class="stack-actions">
          <button type="submit" class="btn btn-primary" <%= product.stock_qty <= 0 ? 'disabled' : '' %>>Add to Cart</button>
          <a class="btn btn-outline" target="_blank" rel="noreferrer" href="<%= waLink %>">Order on WhatsApp</a>
        </div>
      </form>
    </div>
  </div>
</section>

